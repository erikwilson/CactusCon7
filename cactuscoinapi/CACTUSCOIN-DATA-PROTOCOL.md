# Cactuscoin Data Protocol 
The Cactuscoin Data Protocol (CDP) is used to exchange binary messages between badges for proof of presence, registeration with the cactuscoinapi, and submission of coins to the API. All data is in network order (big-endian) unless otherwise specified.

## Header 
Every CDP message must begin with headers that contain: the version number (1 byte), the badge id (2 bytes) sending this CDP, the message type (1 byte.. see table below), the total length of just the message (2 bytes), and the RSA signature of the entire message plus headers except the signature (256 bytes).

>
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |    Version    |           Badge ID            |    Msg Type   |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |          Message Len          |           Signature           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                     Signature (256 bytes)                     |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


The different message types supported in protocol version 1 are described below:

| Type Number  | Name                             | Description                                                                |
| -------------|----------------------------------| ---------------------------------------------------------------------------|
| 1            | Registration Under BadgeID (RUB) | A message directed to the cactuscoin API to register a name with a badge   |
| 2            | Global Broadcast Payload (GBP)   | Periodically generated by badges to broadcast their presence to others     |
| 3            | Cactuscoin Signing Request (CSR) | A request made on behalf of a badge that sees a GBP to create a coin       |
| 4            | Coin Authentication Digest (CAD) | The respone made by a badge that receives a CSR, it is final stage in coin creation and is the proof of presence submitted to the cactuscoin api by both badges. |
| 5            | Automatic Tunneled Message (ATM) | A message that is tunneled through a cactuscoin node to the cactuscoin api |

## 1 - Registration Under BadgeID (RUB)
This message should be sent when a badge desires to begin playing the game and have a name registered with it.  This message contains: the length of the name being submitted, and the name as a UTF8 encoded string.  Upon receiving a RUB the cactuscoin api should update the name stored with the associated badge id and mark it as eligible for playing the game.  Badges may not begin to accumulate points until it has registered.

>
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |          Name Length          |          Name (UTF8)          |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                          Name (UTF8)                          |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                          Name (UTF8)                          |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


## 2 - Global Broadcast Payload (GBP)
This message should be periodically broadcasted by both badges and cactuscoin nodes (for location awards) over LoRa.  This message contains no fields as there is enough data in the headers to determine which badge it originated from.  

## 3 - Cactuscoin Signing Request (CSR)
The CSR message is sent by a badge having seen another badge transmitting a GBP.  It is the first part of establishing a cactuscoin.  It contains 2 fields, the CSR ID which is the badge id of the badge that saw the GBP and initiated the CSR, the broadcasted id which is the badge ID that was contained in the initial GBP.

>
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |             CSR ID            |         Broadcasted ID        |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |               Signature by CSR Badge (256 bytes)              |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


## 4 - Cactuscoin Authentication Data (CAD)
The CAD message is sent by a badge that has received a CSR from another badge.  It is the final part of establishing a cactuscoin through a proof of presence.  It contains 4 fields, the CSR ID which is the badge id of the badge that saw the inital GBP, the broadcasted ID which is the badge ID that was contained in the GBP, the RSA signature by the CSR badge, the RSA signature by the broadcast badge (on the badge IDs + CSR signature).

>
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |             CSR ID            |         Broadcasted ID        |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |               Signature by CSR Badge (256 bytes)              |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |            Signature by Broadcast Badge (256 bytes)           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


## 5 - Automatic Tunnel Message (ATM)
An ATM message is a transport message containing a message from a badge that was received over LoRa by a cactuscoin node.  It contains the 4 fields, the location ID of the node that received the message, the length, the RSA signature by the cactuscoin node of just the location and message length fields, and the encapsulated message being tunneled on behalf of the badge.

>
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |         Message Length        |    Tunnelled Badge Message    |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                    Tunnelled Badge Message                    |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

## 6 - Some kind of ack message might be useful? TODO

>
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |            Badge ID           |     Received Message Type     |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |          Response Code        |    Response Message Length    |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                        Respone Message                        |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
